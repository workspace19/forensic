<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>File Structure 3D Viewer ‚Äî Patched</title>
  <style>
    :root{
      --bg:#0f1724; --panel:#0b1220; --muted:#9aa7bf; --accent:#60a5fa;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{display:flex;gap:12px;background:linear-gradient(180deg,#071021 0%, #081528 100%);color:#e6eef8;padding:12px;box-sizing:border-box;}
    /* Left 3D canvas column */
    .viewer {
      flex:1 1 0;
      min-width:420px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
      border-radius:12px;
      padding:12px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
      display:flex;flex-direction:column;
    }
    #canvasContainer {
      flex:1 1 auto;
      position:relative;
      border-radius:8px;
      overflow:hidden;
      background:linear-gradient(180deg,#061222,#03111b);
      min-height:420px;
    }
    #canvasContainer canvas{display:block;width:100%;height:100%;}
    .controls {
      display:flex;gap:8px;align-items:center;padding-top:8px;
    }
    .button {background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer}
    .button:hover{border-color:rgba(96,165,250,0.6);color:var(--accent)}
    /* Right panel: file tree and info */
    .sidebar {
      width:360px;
      max-width:40%;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .panel {
      background:var(--panel);
      border-radius:12px;
      padding:12px;
      box-shadow: 0 8px 24px rgba(2,6,23,0.45);
    }
    .panel h3{margin:0 0 8px 0;color:#cfe6ff;font-size:14px}
    #fileTree {max-height:520px;overflow:auto;padding:6px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .tree-item{display:flex;gap:8px;align-items:center;padding:6px;border-radius:8px;cursor:pointer}
    .tree-item:hover{background:rgba(255,255,255,0.02)}
    .tree-icon{width:28px;text-align:center;font-size:16px}
    .tree-label{flex:1;color:var(--muted);font-size:13px}
    .selectedLabel{color:#fff}
    .info-row{display:flex;justify-content:space-between;gap:8px}
    .muted{color:var(--muted);font-size:13px}
    #filesAnalyzed{font-weight:700;color:#fff}
    /* small responsive */
    @media(max-width:980px){
      .sidebar{width:320px}
    }
    @media(max-width:720px){
      body{flex-direction:column;padding:8px}
      .sidebar{width:100%}
      .viewer{min-width:unset}
    }
  </style>
</head>
<body>
  <div class="viewer panel" aria-label="3D file viewer">
    <h3>3D File Structure Viewer</h3>
    <div id="canvasContainer" tabindex="0" aria-label="3D canvas container"></div>
    <div class="controls" role="toolbar" aria-label="Viewer controls">
      <button id="btnReset" class="button" title="Reset camera">Reset Camera</button>
      <button id="btnToggleAuto" class="button" title="Toggle auto animation">Toggle Anim</button>
      <div style="margin-left:auto" class="muted">Analyzed: <span id="filesAnalyzed">15,847</span></div>
    </div>
  </div>

  <aside class="sidebar">
    <div class="panel" id="treePanel">
      <h3>File Tree</h3>
      <div id="fileTree" role="tree" aria-label="File tree"></div>
    </div>

    <div class="panel" id="infoPanel">
      <h3>Selected File Info</h3>
      <div id="fileInfo" aria-live="polite">
        <div class="muted">No file selected</div>
      </div>
    </div>

    <div class="panel">
      <h3>Notes</h3>
      <div class="muted" style="font-size:13px">
        Click any 3D object or file in the tree to view details. This file includes robust raycasting and safe parsing for numbers.
      </div>
    </div>
  </aside>

  <!-- THREE.js from CDN (change as needed) -->
  <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>

  <script>
  /*************************************************************************
   * Mock or user-provided data for the file structure.
   * Replace the contents of `fileStructure` with your real JSON if needed.
   *************************************************************************/
  const fileStructure = [
    { name: "üìÅ Root", size: 0, created: "2023-09-01", modified: "2025-09-19", type: "folder" },
    { name: "üìÑ report.pdf", size: 234523, created: "2024-01-12", modified: "2025-04-02", type: "file" },
    { name: "üñºÔ∏è images", size: 0, created: "2024-05-14", modified: "2024-12-09", type: "folder" },
    { name: "üîí secrets.txt", size: 123, created: "2021-11-01", modified: "2023-06-07", type: "file" },
    { name: "üì¶ archive.zip", size: 1023940, created: "2022-03-03", modified: "2022-03-04", type: "file" },
    { name: "üìÑ readme.md", size: 702, created: "2020-07-07", modified: "2024-08-21", type: "file" }
  ];

  /*************************************************************************
   * Helpers: robust parseInt for comma containing numbers and small utilities
   *************************************************************************/
  function parseCommaNumber(str){
    if (!str && str !== 0) return 0;
    try {
      return parseInt(String(str).replace(/,/g, ''), 10) || 0;
    } catch (e) {
      return 0;
    }
  }

  // Deterministic-ish mock hash (32 hex chars)
  function generateMockHash(input){
    let hash = 0;
    for (let i = 0; i < input.length; i++){
      const ch = input.charCodeAt(i);
      hash = ((hash << 5) - hash) + ch;
      hash = hash | 0; // ensure 32-bit signed
    }
    // Convert to unsigned and to hex with leading zeros
    return (Math.abs(hash) >>> 0).toString(16).padStart(8, '0')
           + ( (hash ^ 0xdeadbeef) >>> 0 ).toString(16).padStart(8,'0')
           .slice(0,16).padEnd(16,'0');
  }

  function humanFileSize(bytes){
    if (bytes === 0) return '0 B';
    const units = ['B','KB','MB','GB','TB'];
    const i = Math.floor(Math.log(Math.max(1, bytes)) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
  }

  /*************************************************************************
   * Three.js scene setup: scene, camera, renderer, lights
   *************************************************************************/
  let scene, camera, renderer, animationId;
  const fileObjects = []; // top-level groups for raycasting
  const container = document.getElementById('canvasContainer');

  function initThree(){
    const w = container.clientWidth;
    const h = container.clientHeight;

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(50, w/h, 0.1, 1000);
    camera.position.set(0, 3, 10);
    camera.lookAt(0,0,0);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(w, h);
    renderer.setClearColor(0x061426, 1);
    renderer.shadowMap.enabled = true;

    // Clear any existing canvas (if re-init)
    while (container.firstChild) container.removeChild(container.firstChild);
    container.appendChild(renderer.domElement);

    // Lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x080820, 0.8);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(5,10,7);
    dir.castShadow = true;
    scene.add(dir);

    // Ground plane (subtle)
    const plane = new THREE.Mesh(
      new THREE.PlaneGeometry(200,200),
      new THREE.MeshBasicMaterial({ color: 0x03121a, opacity: 0.0, transparent: true })
    );
    plane.rotation.x = -Math.PI/2;
    plane.position.y = -1.5;
    scene.add(plane);

    window.addEventListener('resize', onWindowResize);
  }

  function onWindowResize(){
    const w = container.clientWidth;
    const h = container.clientHeight;
    camera.aspect = w/h;
    camera.updateProjectionMatrix();
    renderer.setSize(w,h);
  }

  /*************************************************************************
   * Build 3D file objects from fileStructure
   *************************************************************************/
  function build3DFromFiles(files){
    // clean old
    fileObjects.forEach(g => {
      if (g.parent) g.parent.remove(g);
    });
    fileObjects.length = 0;

    const gap = 2.0;
    const cols = Math.max(1, Math.ceil(Math.sqrt(files.length)));
    files.forEach((file, i) => {
      const group = new THREE.Group();
      group.userData.fileIndex = i;
      group.userData.isSelected = false;

      // base cube: size depends on file size (folders small)
      const scaleBase = file.type === 'folder' ? 0.9 : Math.min(2.6, 0.6 + Math.log10(Math.max(1, file.size + 1)));
      const geo = new THREE.BoxGeometry(1 * scaleBase, 0.6 * scaleBase, 0.6 * scaleBase);
      const mat = new THREE.MeshStandardMaterial({ color: file.type === 'folder' ? 0x2b6cb0 : 0x0ea5a4, roughness: 0.45, metalness: 0.1 });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.castShadow = true;
      mesh.receiveShadow = true;
      group.add(mesh);

      // small label as a sprite using canvas texture
      const labelCanvas = document.createElement('canvas');
      labelCanvas.width = 256; labelCanvas.height = 64;
      const ctx = labelCanvas.getContext('2d');
      ctx.fillStyle = 'rgba(0,0,0,0)';
      ctx.fillRect(0,0,256,64);
      ctx.font = '20px sans-serif';
      ctx.fillStyle = '#e6eef8';
      // parse emoji + label robustly: match first token (non-space) and the rest
      const parts = String(file.name || '').match(/^(\S+)\s+(.*)$/);
      const icon = parts ? parts[1] : (file.type === 'folder' ? 'üìÅ' : 'üìÑ');
      const label = parts ? parts[2] : file.name;
      ctx.fillText(icon + ' ' + (label || 'untitled'), 6, 36);

      const texture = new THREE.CanvasTexture(labelCanvas);
      texture.needsUpdate = true;
      const spriteMaterial = new THREE.SpriteMaterial({ map: texture, depthTest: true, sizeAttenuation: false });
      const sprite = new THREE.Sprite(spriteMaterial);
      sprite.position.set(0, 0.6 * scaleBase + 0.12, 0);
      sprite.scale.set(2.6, 0.65, 1);
      group.add(sprite);

      // Position on grid
      const row = Math.floor(i / cols);
      const col = i % cols;
      group.position.set( (col - (cols/2)) * gap, (Math.random()*0.4) - 0.2, (row - (cols/2)) * gap * 0.7 );

      // store baseY to prevent drift
      group.userData.baseY = group.position.y;

      // Add to scene and lists
      scene.add(group);
      fileObjects.push(group);
    });
  }

  /*************************************************************************
   * Raycasting and selection: recursive searching and climbing to the group
   *************************************************************************/
  const raycaster = new THREE.Raycaster();
  let isAutoAnim = true;
  let isMouseDown = false;

  function containerClickHandler(event){
    // If dragging or panning, you may choose to ignore clicks
    if (isMouseDown) return;

    const rect = container.getBoundingClientRect();
    const mouse = new THREE.Vector2();
    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    // recursive true so children are checked
    const intersects = raycaster.intersectObjects(fileObjects, true);
    if (intersects.length > 0){
      let obj = intersects[0].object;
      // climb up to parent until we find userData.fileIndex
      while (obj && (obj.userData === undefined || typeof obj.userData.fileIndex === 'undefined')){
        obj = obj.parent;
      }
      if (obj && obj.userData && typeof obj.userData.fileIndex !== 'undefined'){
        selectFile(obj.userData.fileIndex);
      }
    }
  }

  container.addEventListener('click', containerClickHandler);
  container.addEventListener('mousedown', () => { isMouseDown = true; });
  container.addEventListener('mouseup', () => { setTimeout(()=> isMouseDown = false, 50); });

  /*************************************************************************
   * Selection handler: highlight group + populate info panel + tree sync
   *************************************************************************/
  function selectFile(index){
    fileObjects.forEach((g) => {
      if (g.userData.fileIndex === index){
        g.userData.isSelected = true;
        // pop-out selected slightly
        g.position.y = g.userData.baseY + 0.45;
        // tint material by setting emissive if exists
        if (g.children[0] && g.children[0].material) g.children[0].material.emissive = new THREE.Color(0x1a365f);
      } else {
        g.userData.isSelected = false;
        // return to base
        if (g.userData.baseY !== undefined) g.position.y = g.userData.baseY;
        if (g.children[0] && g.children[0].material) g.children[0].material.emissive = new THREE.Color(0x000000);
      }
    });

    // Update info panel
    const file = fileStructure[index];
    const infoPanel = document.getElementById('fileInfo');
    infoPanel.innerHTML = `
      <div style="font-weight:700">${escapeHtml(file.name)}</div>
      <div class="muted">Type: ${escapeHtml(file.type || 'unknown')} ‚Ä¢ Size: ${humanFileSize(file.size || 0)}</div>
      <div class="muted">Created: ${file.created || '‚Äî'} ‚Ä¢ Modified: ${file.modified || '‚Äî'}</div>
      <div style="margin-top:8px;font-family:monospace;font-size:12px;color:#dbe9ff">Hash: ${generateMockHash(file.name || String(index))}</div>
    `;

    // Select corresponding tree item highlight
    const items = document.querySelectorAll('.tree-item');
    items.forEach((el) => {
      const idx = parseInt(el.dataset.index, 10);
      if (idx === index) el.querySelector('.tree-label').classList.add('selectedLabel');
      else el.querySelector('.tree-label').classList.remove('selectedLabel');
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  /*************************************************************************
   * Single robust animation loop (do not duplicate)
   *************************************************************************/
  function animate3D(){
    animationId = requestAnimationFrame(animate3D);

    const time = Date.now() * 0.001;

    fileObjects.forEach((g, index) => {
      // gentle float anchored at baseY
      if (!('baseY' in g.userData)) g.userData.baseY = g.position.y;
      g.position.y = g.userData.baseY + Math.sin(time + index * 0.5) * 0.07;

      // rotation slow; selected rotates faster
      if (g.userData.isSelected){
        g.rotation.y += 0.03;
        if (g.children[0] && g.children[0].material) {
          const pulse = Math.abs(Math.sin(time * 3)) * 0.6 + 0.2;
          g.children[0].material.emissive = new THREE.Color(pulse * 0.1, pulse * 0.15, pulse * 0.25);
        }
      } else {
        g.rotation.y += 0.006;
        if (g.children[0] && g.children[0].material) {
          g.children[0].material.emissive = new THREE.Color(0,0,0);
        }
      }
    });

    // optionally rotate camera slowly if auto anim enabled
    if (isAutoAnim){
      const radius = 10;
      const t = Date.now() * 0.00008;
      camera.position.x = Math.cos(t) * radius;
      camera.position.z = Math.sin(t) * radius;
      camera.lookAt(0,0,0);
    }

    renderer.render(scene, camera);
  }

  /*************************************************************************
   * File tree (DOM) population with robust emoji/label splitting
   *************************************************************************/
  function populateFileTree(files){
    const tree = document.getElementById('fileTree');
    tree.innerHTML = '';
    files.forEach((file, i) => {
      const item = document.createElement('div');
      item.className = 'tree-item';
      item.dataset.index = i;

      // robust split: first non-space token as icon, rest as label
      const parts = String(file.name || '').match(/^(\S+)\s+(.*)$/);
      const icon = parts ? parts[1] : (file.type === 'folder' ? 'üìÅ' : 'üìÑ');
      const label = parts ? parts[2] : (file.name || 'untitled');

      item.innerHTML = `<div class="tree-icon" aria-hidden="true">${escapeHtml(icon)}</div>
                        <div class="tree-label">${escapeHtml(label)}</div>
                        <div style="margin-left:8px" class="muted">${humanFileSize(file.size || 0)}</div>`;

      item.addEventListener('click', () => { selectFile(i); /* also trigger 3D highlight */ });
      tree.appendChild(item);
    });
  }

  /*************************************************************************
   * Small UI wiring and init
   *************************************************************************/
  document.getElementById('btnReset').addEventListener('click', () => {
    camera.position.set(0,3,10);
    camera.lookAt(0,0,0);
  });

  document.getElementById('btnToggleAuto').addEventListener('click', () => {
    isAutoAnim = !isAutoAnim;
  });

  // Initialize UI number display safely (strip commas before parse)
  (function initAnalyzedNumber(){
    const el = document.getElementById('filesAnalyzed');
    const current = parseCommaNumber(el.textContent);
    el.textContent = (current + Math.floor(Math.random()*20)).toLocaleString();
  })();

  /*************************************************************************
   * Boot sequence
   *************************************************************************/
  function boot(){
    initThree();
    build3DFromFiles(fileStructure);
    populateFileTree(fileStructure);
    // start animation
    cancelAnimationFrame(animationId);
    animate3D();
  }

  boot();

  /*************************************************************************
   * Expose a quick method to update data if someone wants to replace fileStructure
   *************************************************************************/
  window.updateFileStructure = function(newFiles){
    if (!Array.isArray(newFiles)) return;
    // shallow replace
    while(fileStructure.length) fileStructure.pop();
    newFiles.forEach(f => fileStructure.push(f));
    build3DFromFiles(fileStructure);
    populateFileTree(fileStructure);
  };

  </script>
</body>
</html>